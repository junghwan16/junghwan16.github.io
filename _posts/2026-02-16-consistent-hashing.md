---
layout: single
title: "안정 해싱(Consistent Hashing)과 Virtual Node"
date: 2026-02-16 16:00:00 +0900
categories: [backend, infrastructure]
---

## 왜 안정 해싱이 필요한가

일반적인 방식은 나머지 연산이다.

```
server = hash(key) % N
```

서버가 3대에서 4대로 늘어나면? 거의 모든 key가 다른 서버로 이동한다. 전체 데이터를 다시 옮겨야 한다. 대규모 시스템에서는 재앙이다.

---

## 해결 아이디어: 서버를 원 위에 올려놓자

해시 값 범위를 0~100이라고 가정하고 원(링)으로 만든다.

```
        0
    90     10

  80           20

  70           30

    60     40
        50
```

서버를 링 위에 배치한다.

```
S1 → 20
S2 → 50
S3 → 80
```

규칙은 단순하다.

> key를 해싱해서 링 위에 찍고, 시계 방향으로 가장 먼저 만나는 서버에 저장한다.

예시:

- key=25 → 50(S2)
- key=78 → 80(S3)
- key=85 → 20(S1) ← 80을 지나 한 바퀴 돌아서

---

## 서버를 추가하면?

S4를 65 위치에 추가한다.

```
50(S2) → 65(S4) → 80(S3)
```

50~65 구간의 key만 S4로 이동한다. 나머지는 그대로다.

이것이 "Consistent"의 의미다. **서버가 추가되거나 제거되어도 영향을 받는 key가 일부에 한정된다.**

---

## 부하 불균형 문제

서버가 이렇게 배치되면 어떻게 될까?

```
S1 → 10
S2 → 15
S3 → 80
```

S1과 S3은 담당 구간이 크고, S2는 거의 없다. 부하가 한쪽으로 쏠린다.

---

## 해결책: Virtual Node

한 서버를 링 위 여러 지점에 배치한다.

```
S1 → 10, 40, 75
S2 → 20, 55, 85
S3 → 5, 35, 65
```

링 위에 정렬하면:

```
5(S3) → 10(S1) → 20(S2) → 35(S3) → 40(S1) → 55(S2) → 65(S3) → 75(S1) → 85(S2)
```

서버들이 링 전체에 골고루 퍼지면서 큰 구간을 독점하는 문제가 줄어든다.

---

## 왜 많이 쪼갤수록 균등해지는가

다트판에 다트를 던진다고 생각하면 된다.

- 3번 던지면 몰릴 수 있다.
- 300번 던지면 전체에 퍼진다.

많이 찍을수록 평균에 가까워진다. 핵심만 말하면:

> 오차는 $\sqrt{\text{가상노드 개수}}$에 반비례한다.

Virtual Node를 4배 늘리면 불균형은 절반으로 줄어든다.

| Virtual Node 수 | 분포 |
|---|---|
| 1개 | 편차 매우 큼 |
| 10개 | 꽤 안정적 |
| 100개 | 거의 균등 |

실제 시스템에서도 이 원리를 따른다.

- Cassandra → 256개
- Dynamo 계열 → 수십~수백 개

---

## 전체 흐름

```
나머지(%) 방식
  → 서버 수 변하면 전체 이동

Consistent Hashing 도입
  → 링 구조로 일부만 이동

간격 불균형 발생
  → Virtual Node 도입
  → 랜덤 평균 효과로 균등 분배
```

---

## 과제: Virtual Node의 균등 분포를 수학적으로 증명해 보기

Virtual Node가 많아질수록 각 서버가 담당하는 구간이 균등해진다는 것을 직관적으로는 이해했다. 이를 수학적으로 증명해 보자.

**힌트:**

- 링의 전체 길이를 1로 정규화한다.
- 서버 $k$대가 각각 $v$개의 Virtual Node를 가지면, 링 위에 총 $n = k \times v$개의 점이 균일 분포(Uniform Distribution)로 찍힌다.
- 연속한 두 점 사이 gap 하나의 기댓값은 $\frac{1}{n}$이다.
- 서버 한 대는 $v$개의 gap을 담당하므로, 총 담당 비율의 기댓값은 $\frac{v}{n} = \frac{1}{k}$이다.
- $v$가 커질수록 서버별 담당 비율의 분산이 0에 수렴함을 보이면 된다.

---

## 참고자료

- [Consistent Hashing and Random Trees (Karger et al., 1997)](https://www.cs.princeton.edu/courses/archive/fall09/cos518/papers/chash.pdf) — 안정 해싱의 원 논문
- [Dynamo: Amazon's Highly Available Key-value Store](https://www.allthingsdistributed.com/files/amazon-dynamo-soho2007.pdf) — Virtual Node를 활용한 실제 시스템 설계
